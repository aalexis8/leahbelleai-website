---
import Layout from '@/layouts/Layout.astro';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const posts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const categories = ['All', 'ETL', 'Data Modeling', 'Data Integration', 'Best Practices', 'Industry Insights'];

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}
---

<Layout 
  title="Blog" 
  description="Insights, best practices, and industry knowledge from LeahBelle AI Consulting."
>
  <Header />
  
  <main class="flex-grow">
    <!-- Hero -->
    <section class="section bg-gradient-to-br from-gray-50 to-white">
      <div class="container text-center">
        <h1 class="mb-6">Our <span class="gradient-text">Blog</span></h1>
        <p class="text-xl text-gray-600 max-w-2xl mx-auto">
          Insights, best practices, and industry knowledge from our data experts.
        </p>
      </div>
    </section>

    <!-- Filter & Posts -->
    <section class="section bg-white">
      <div class="container">
        <!-- Category Filter -->
        <div class="flex flex-wrap gap-3 mb-12 justify-center">
          {categories.map((category) => (
            <button
              data-category={category}
              class:list={[
                'px-4 py-2 rounded-full font-medium transition-all category-btn',
                category === 'All' 
                  ? 'bg-gradient-brand text-white' 
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              ]}
            >
              {category}
            </button>
          ))}
        </div>

        <!-- Search -->
        <div class="max-w-md mx-auto mb-12">
          <div class="relative">
            <input
              type="text"
              id="search-input"
              placeholder="Search articles..."
              class="w-full px-4 py-3 pl-12 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary-purple focus:border-transparent outline-none transition"
            />
            <svg class="w-5 h-5 text-gray-400 absolute left-4 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
        </div>

        <!-- Posts Grid -->
        <div id="posts-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
          {posts.map((post) => (
            <article 
              class="card group post-card" 
              data-category={post.data.category}
              data-title={post.data.title.toLowerCase()}
              data-description={post.data.description.toLowerCase()}
            >
              <div class="mb-4">
                <span class="inline-block px-3 py-1 text-sm font-medium bg-primary-purple/10 text-primary-purple rounded-full">
                  {post.data.category}
                </span>
              </div>
              <h3 class="text-xl mb-3 group-hover:text-primary-purple transition-colors">
                <a href={`/blog/${post.slug}`}>{post.data.title}</a>
              </h3>
              <p class="text-gray-600 mb-4 line-clamp-3">{post.data.description}</p>
              <div class="flex items-center justify-between text-sm text-gray-500">
                <span>{formatDate(post.data.pubDate)}</span>
                <a 
                  href={`/blog/${post.slug}`} 
                  class="text-primary-purple font-medium flex items-center group-hover:underline"
                >
                  Read more
                  <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </a>
              </div>
            </article>
          ))}
        </div>

        <!-- No Results -->
        <div id="no-results" class="hidden text-center py-12">
          <p class="text-xl text-gray-500">No articles found matching your criteria.</p>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<script>
  const categoryBtns = document.querySelectorAll('.category-btn');
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const postCards = document.querySelectorAll('.post-card');
  const noResults = document.getElementById('no-results');
  
  let activeCategory = 'All';
  let searchQuery = '';

  function filterPosts() {
    let visibleCount = 0;
    
    postCards.forEach((card) => {
      const cardCategory = card.getAttribute('data-category');
      const cardTitle = card.getAttribute('data-title') || '';
      const cardDescription = card.getAttribute('data-description') || '';
      
      const matchesCategory = activeCategory === 'All' || cardCategory === activeCategory;
      const matchesSearch = searchQuery === '' || 
        cardTitle.includes(searchQuery) || 
        cardDescription.includes(searchQuery);
      
      if (matchesCategory && matchesSearch) {
        (card as HTMLElement).style.display = 'block';
        visibleCount++;
      } else {
        (card as HTMLElement).style.display = 'none';
      }
    });

    if (noResults) {
      noResults.classList.toggle('hidden', visibleCount > 0);
    }
  }

  categoryBtns.forEach((btn) => {
    btn.addEventListener('click', () => {
      categoryBtns.forEach((b) => {
        b.classList.remove('bg-gradient-brand', 'text-white');
        b.classList.add('bg-gray-100', 'text-gray-700');
      });
      btn.classList.remove('bg-gray-100', 'text-gray-700');
      btn.classList.add('bg-gradient-brand', 'text-white');
      
      activeCategory = btn.getAttribute('data-category') || 'All';
      filterPosts();
    });
  });

  searchInput?.addEventListener('input', (e) => {
    searchQuery = (e.target as HTMLInputElement).value.toLowerCase();
    filterPosts();
  });
</script>

